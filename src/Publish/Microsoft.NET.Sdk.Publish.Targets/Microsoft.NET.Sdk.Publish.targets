<!--
***********************************************************************************************
Microsoft.NET.Sdk.Publish.targets  

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your web deploy projects from the command-line or the IDE.

This file defines the steps in the standard build process to deploy web application projects.

Copyright (C) Microsoft Corporation. All rights reserved.
***********************************************************************************************
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Properties corresponding to the tasks and targets path-->
  
  <PropertyGroup>
    <!-- We want to force this property to be true, hence not adding a condition check -->
    <SupportsDeployOnBuild>true</SupportsDeployOnBuild>
    <_PublishTaskFramework Condition=" '$(MSBuildRuntimeType)' == 'Core'">netcoreapp1.0</_PublishTaskFramework>
    <_PublishTaskFramework Condition=" '$(_PublishTaskFramework)' == ''">net46</_PublishTaskFramework>
    <_PublishTasksDir Condition=" '$(_PublishTasksDir)'=='' ">$(MSBuildThisFileDirectory)..\..\tools\$(_PublishTaskFramework)\</_PublishTasksDir>
    <_PublishTaskAssemblyFullPath Condition=" '$(_PublishTaskAssemblyFullPath)'=='' ">$(_PublishTasksDir)\Microsoft.NET$(MSBuildRuntimeType).Sdk.Publish.Tasks.dll</_PublishTaskAssemblyFullPath>
    <_CopyTargetsDir Condition=" '$(_CopyTargetsDir)' == ''">$(MSBuildThisFileDirectory)CopyTargets\</_CopyTargetsDir>
    <_TransformTargets Condition=" '$(_TransformTargets)' == ''">$(MSBuildThisFileDirectory)TransformTargets\</_TransformTargets>
    <_ComputeTargetsDir Condition=" '$(_ComputeTargetsDir)'=='' ">$(MSBuildThisFileDirectory)ComputeTargets\</_ComputeTargetsDir>
    <_PublishTargetsDir Condition=" '$(_PublishTargetsDir)'=='' ">$(MSBuildThisFileDirectory)PublishTargets\</_PublishTargetsDir>
    <_PublishProfilesDir Condition=" '$(_PublishProfilesDir)'=='' ">$(MSBuildThisFileDirectory)PublishProfiles\</_PublishProfilesDir>
  </PropertyGroup>

  <!-- Extension points for BeforePublish and AfterPublish-->
  <Target Name="BeforePublish" />
  <Target Name="AfterPublish" />

  <!--
  ***********************************************************************************************
  Import the PublishProfiles
  ***********************************************************************************************
 -->

  <PropertyGroup>
    <_PublishProfileRootFolder Condition="'$(_PublishProfileRootFolder)' == '' and '$(MSBuildProjectExtension)' =='.vbproj' ">$(MSBuildProjectDirectory)\My Project\PublishProfiles\</_PublishProfileRootFolder>
    <_PublishProfileRootFolder Condition="'$(_PublishProfileRootFolder)' == '' and '$(MSBuildProjectExtension)' =='.csproj' ">$(MSBuildProjectDirectory)\Properties\PublishProfiles\</_PublishProfileRootFolder>
    <PublishProfile Condition="'$(PublishProfile)' ==''">DefaultProfile</PublishProfile>
    <PublishProfileName Condition="'$(PublishProfileName)' == ''">$([System.IO.Path]::GetFileNameWithoutExtension($(PublishProfile)))</PublishProfileName>
    <PublishProfileFullPath Condition="'$(PublishProfileFullPath)' == ''">$(_PublishProfileRootFolder)$(PublishProfileName).pubxml</PublishProfileFullPath>
    <PublishProfileFullPath Condition="!Exists('$(PublishProfileFullPath)')">$(_PublishProfilesDir)$(PublishProfileName).pubxml</PublishProfileFullPath>

    <!-- This is what get passed from the Visual Studio UI.-->
    <WebPublishProfileFile Condition="'$(WebPublishProfileFile)' == ''">$(PublishProfileFullPath)</WebPublishProfileFile>
  </PropertyGroup>

  <Import Project="$(WebPublishProfileFile)" Condition="Exists('$(WebPublishProfileFile)')" />

  <!--
  ***********************************************************************************************
  Set the properties based on PublishProfile properties
  ***********************************************************************************************
 -->

  <PropertyGroup>
    <!-- Properties for identifying the Publish Protocol -->
    <PublishProtocol Condition="'$(PublishProtocol)' == ''">$(WebPublishMethod)</PublishProtocol>
    <!-- For backward compat -->
    <PublishProtocol Condition="'$(PublishProtocol)' == 'Package'">MSDeployPackage</PublishProtocol>
    
    <!-- Properties setting the publish intermediate paths -->
    <PublishConfiguration Condition ="'$(PublishConfiguration)' == ''">$(LastUsedBuildConfiguration)</PublishConfiguration>
    <PublishConfiguration Condition="'$(PublishConfiguration)' == ''">$(Configuration)</PublishConfiguration>
    <_PublishConfigurationPath Condition="'$(_PublishConfigurationPath)' == ''">$(PublishConfiguration)\</_PublishConfigurationPath>

    <PublishFramework Condition="'$(PublishFramework)' == '' And '$(_PublishProjectType)' == 'Core' ">$(TargetFramework)</PublishFramework>
    <PublishFramework Condition="'$(PublishFramework)' == '' And '$(_PublishProjectType)' == 'Core' ">netcoreapp1.0</PublishFramework>
    <_PublishFrameworkPath Condition="'$(_PublishFrameworkPath)' == '' And '$(_PublishProjectType)' == 'Core' ">$(PublishFramework)\</_PublishFrameworkPath>

    <BaseIntermediateOutputPath Condition="'$([System.IO.Path]::IsPathRooted($(BaseIntermediateOutputPath)))' == 'False'">$(MSBuildProjectDirectory)\$(BaseIntermediateOutputPath)</BaseIntermediateOutputPath>
    <BaseIntermediateOutputPath Condition="!HasTrailingSlash('$(BaseIntermediateOutputPath)')">$(BaseIntermediateOutputPath)\</BaseIntermediateOutputPath>

    <PublishIntermediateTempPath Condition="'$(PublishIntermediateTempPath)' == ''">$([System.IO.Path]::GetFullPath($(BaseIntermediateOutputPath)$(_PublishConfigurationPath)$(_PublishFrameworkPath)PublishTemp\))</PublishIntermediateTempPath>
    <PublishIntermediateOutputPath Condition="'$(PublishIntermediateOutputPath)' == ''">$(PublishIntermediateTempPath)PublishOutput\</PublishIntermediateOutputPath>
  </PropertyGroup>
 
  <!--
  ***********************************************************************************************
  Import the Compute target
  ***********************************************************************************************
 -->

  <Import Project="$(_ComputeTargetsDir)Microsoft.NET.Sdk.Publish.ComputeFiles.targets" Condition="Exists('$(_ComputeTargetsDir)Microsoft.NET.Sdk.Publish.ComputeFiles.targets')" />

  <!--
  ***********************************************************************************************
  Import the Copy target
  ***********************************************************************************************
 -->
  
  <Import Project="$(_CopyTargetsDir)Microsoft.NET.Sdk.Publish.CopyFiles.targets" Condition="Exists('$(_CopyTargetsDir)Microsoft.NET.Sdk.Publish.CopyFiles.targets')"/>


  <!--
  ***********************************************************************************************
  Import the transform target
  ***********************************************************************************************
 -->

  <Import Project="$(_CopyTargetsDir)Microsoft.NET.Sdk.Publish.CopyFiles.targets" Condition="Exists('$(_CopyTargetsDir)Microsoft.NET.Sdk.Publish.TransformFiles.targets')"/>

  <!--
  ***********************************************************************************************
  Import the Protocol target
  ***********************************************************************************************
 -->
  
  <Import Project="$(_PublishTargetsDir)Microsoft.NET.Sdk.Publish.$(PublishProtocol).targets" Condition="Exists('$(_PublishTargetsDir)Microsoft.NET.Sdk.Publish.$(PublishProtocol).targets')"/>
  
  <!--
  ***********************************************************************************************
  TARGET : DotNetPublish
  ***********************************************************************************************
 -->

  <PropertyGroup>
    <DotNetPublishDependsOn>
      BeforePublish;
      CorePublish;
      AfterPublish;
    </DotNetPublishDependsOn>
  </PropertyGroup>
  
  <Target Name="DotNetPublish" 
          DependsOnTargets="$(DotNetPublishDependsOn)" 
          AfterTargets="Build" 
          Condition=" '$(DeployOnBuild)' == 'true' " />


  <PropertyGroup>
    <CorePublishDependsOn>
      $(_DotNetPublishComputeFiles);
      $(_DotNetPublishCopyFiles);
      $(_DotNetPublishTransformFiles);
      $(_DotNetPublishFiles);
    </CorePublishDependsOn>
  </PropertyGroup>

  <Target Name="CorePublish" 
          DependsOnTargets="$(CorePublishDependsOn)"/>

</Project>
