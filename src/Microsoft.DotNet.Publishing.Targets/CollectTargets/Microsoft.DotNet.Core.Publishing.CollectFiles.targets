<!--
***********************************************************************************************
Microsoft.DotNet.Core.Publishing.CollectFiles.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your web deploy projects from the command-line or the IDE.

This file defines the steps in the standard package/publish process for collecting only files to run the web appliation.

Copyright (C) Microsoft Corporation. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="WebConfigTransform" AssemblyFile="$(DotNetPublishingTasksDir)Microsoft.DotNet.Publishing.Tasks.dll"/>

  <PropertyGroup>
    <DotNetPublishCollectFiles>
      Publish;
      $(DotNetPublishCollectFiles);
      CollectFilesFromPublishDir;
    </DotNetPublishCollectFiles>
  </PropertyGroup>


  <!--***************************************************************-->
  <!-- Task CollectFilesFromPublishDir                               -->
  <!--***************************************************************-->
  <PropertyGroup>
    <CollectFilesFromPublishDirDependsOn>
      $(CollectFilesFromPublishDirDependsOn);
    </CollectFilesFromPublishDirDependsOn>
  </PropertyGroup>
  
  <Target Name="CollectFilesFromPublishDir"
        DependsOnTargets="$(CollectFilesFromPublishDirDependsOn)"
        Condition="'$(PublishDir)' != ''">

  <!-- Currently the publish target does not transform the web.config, Hence adding the logic here to transform the web.config from project path -->
    <WebConfigTransform
    ProjectDirectory="$(MSBuildProjectDirectory)"
    PublishDir="$(PublishDir)"
    AssemblyName="$(AssemblyName)"
    IsPortableApp="true"
    />

    <ItemGroup>
      <_PublishDirFiles
        Include="$(PublishDir)**\*.*">
      </_PublishDirFiles>
    </ItemGroup>

    <CreateItem
      Include="@(_PublishDirFiles)"
      AdditionalMetadata="DestinationRelativePath=%(RecursiveDir)%(Filename)%(Extension)">
      <Output TaskParameter="Include" ItemName="_publishDirFilesWithMetadata"/>
    </CreateItem>

    <ItemGroup>
      <DotNetPublishFiles Include="@(_publishDirFilesWithMetadata)" />
    </ItemGroup>

  </Target>

</Project>
