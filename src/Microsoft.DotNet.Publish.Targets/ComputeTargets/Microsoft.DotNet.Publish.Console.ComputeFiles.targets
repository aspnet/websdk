<!--
***********************************************************************************************
Microsoft.DotNet.Publish.Console.ComputeFiles.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your web deploy projects from the command-line or the IDE.

This file defines the steps in the standard package/publish process for collecting only files to run the web appliation.

Copyright (C) Microsoft Corporation. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <WebJobType Condition="'$(WebJobType)' == ''">Continuous</WebJobType>
    <WebJobName Condition="'$(WebJobName)' == ''">$(AssemblyName)</WebJobName>
    <WebJobAppDataPath Condition="'$(WebJobAppDataPath)' == ''" >app_data\Jobs\$(WebJobType)\$(WebJobName)\</WebJobAppDataPath>
    <ComputeFilesFromOutDirPrefix Condition="'$(ComputeFilesFromOutDirPrefix)' == ''">$(WebJobAppDataPath)</ComputeFilesFromOutDirPrefix>
    <ComputeFilesFromContentPrefix Condition="'$(ComputeFilesFromContentPrefix)' == ''"></ComputeFilesFromContentPrefix>
  </PropertyGroup>

  <PropertyGroup>
    <DotNetPublishComputeFiles>
      $(DotNetPublishComputeFiles);
      ComputeFilesFromOutDir;
      ComputeFilesFromContent;
    </DotNetPublishComputeFiles>
  </PropertyGroup>

  <!--***************************************************************-->
  <!-- Target ComputeFilesFromOutDir                     -->
  <!--***************************************************************-->
  <PropertyGroup>
    <ComputeFilesFromOutDirDependsOn>
      $(ComputeFilesFromOutDirDependsOn);
    </ComputeFilesFromOutDirDependsOn>
  </PropertyGroup>

  <Target Name="ComputeFilesFromOutDir"
          DependsOnTargets="$(ComputeFilesFromOutDirDependsOn)"
          Condition="'$(OutDir)' != ''">

    <ItemGroup>
      <_OutDirFiles
        Include="$(OutDir)**\*.*"
        Exclude="$(OutDir)PublishOutput\**\*.*">
      </_OutDirFiles>
    </ItemGroup>

    <CreateItem
      Include="@(_OutDirFiles)"
      AdditionalMetadata="DestinationRelativePath=$(ComputeFilesFromOutDirPrefix)%(RecursiveDir)%(Filename)%(Extension)">
      <Output TaskParameter="Include" ItemName="_OutDirFilesWithMetadata"/>
    </CreateItem>

    <ItemGroup>
      <DotNetPublishFiles Include="@(_OutDirFilesWithMetadata)" />
    </ItemGroup>

  </Target>

  <!--***************************************************************-->
  <!-- Target ComputeFilesFromContent                     -->
  <!--***************************************************************-->
  <PropertyGroup>
    <ComputeFilesFromContentDependsOn>
      $(ComputeFilesFromContentDependsOn);
    </ComputeFilesFromContentDependsOn>
  </PropertyGroup>

  <Target Name="ComputeFilesFromContent"
          DependsOnTargets="$(ComputeFilesFromContentDependsOn)"
          Condition="'@(Content)' != ''">

    <CreateItem
      Include="@(Content)"
      AdditionalMetadata="DestinationRelativePath=$(ComputeFilesFromContentPrefix)%(Identity)">
      <Output TaskParameter="Include" ItemName="_ContentFilesWithMetadata"/>
    </CreateItem>

    <ItemGroup>
      <DotNetPublishFiles Include="@(_ContentFilesWithMetadata)" />
    </ItemGroup>
  </Target>

  <!--********************************************************************-->
  <!-- This will ensure that all values have the required metadata -->
  <!--********************************************************************-->
  <ItemDefinitionGroup>
    <DotNetPublishFiles>
      <DestinationRelativePath></DestinationRelativePath>
      <Exclude>False</Exclude>
    </DotNetPublishFiles>
  </ItemDefinitionGroup>
  
</Project>
