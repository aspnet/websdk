<!--
***********************************************************************************************
Microsoft.NET.Sdk.Publish.Core.ComputeFiles.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your web deploy projects from the command-line or the IDE.

This file defines the steps in the standard package/publish process for collecting only files to run the web appliation.

Copyright (C) Microsoft Corporation. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask TaskName="TransformWebConfig" AssemblyFile="$(_PublishTaskAssemblyFullPath)"/>

  <PropertyGroup>
    <_DotNetPublishComputeFiles>
      $(_DotNetPublishComputeFiles);
      _PrepareForDotNetPublish;
      Publish;
      _ComputeFilesFromPublishDir;
    </_DotNetPublishComputeFiles>
  </PropertyGroup>

  <!--***************************************************************-->
  <!-- Target _PrepareForDotNetPublish                               -->
  <!--***************************************************************-->
  <PropertyGroup>
    <_PrepareForDotNetPublishDependsOn>
      $(_PrepareForDotNetPublishDependsOn);
    </_PrepareForDotNetPublishDependsOn>
  </PropertyGroup>
  
  <Target Name="_PrepareForDotNetPublish">
    
    <PropertyGroup>
      <PublishDir>$([System.IO.Path]::GetTempPath())\PublishTemp\</PublishDir>
      <TargetFramework>$(PublishFramework)</TargetFramework>
      <RuntimeIdentifier>$(PublishRuntime)</RuntimeIdentifier>
      <Configuration>$(PublishConfiguration)</Configuration>
    </PropertyGroup>
  </Target>
  

  <!--***************************************************************-->
  <!-- Target _ComputeFilesFromPublishDir                               -->
  <!--***************************************************************-->
  <PropertyGroup>
    <_ComputeFilesFromPublishDirDependsOn>
      $(_ComputeFilesFromPublishDirDependsOn);
    </_ComputeFilesFromPublishDirDependsOn>
  </PropertyGroup>
  
  <Target Name="_ComputeFilesFromPublishDir"
        DependsOnTargets="$(_ComputeFilesFromPublishDirDependsOn)"
        Condition="'$(PublishDir)' != ''">

    <PropertyGroup>
      <_ProjectCapability>@(ProjectCapability)</_ProjectCapability>
      <_IsWebProject Condition="$(_ProjectCapability.Contains('DotNetCoreWeb'))">true</_IsWebProject>
      <_IsPortable Condition=" '$(_IsPortable)' == '' ">true</_IsPortable>
      <_TransformWebConfigForAzure Condition=" '$(WEBSITE_SITE_NAME)' != '' Or '$(DOTNET_CONFIGURE_AZURE)' == 'true' Or '$(DOTNET_CONFIGURE_AZURE)' == '1'">true</_TransformWebConfigForAzure>
    </PropertyGroup>

    <TransformWebConfig
        Condition="'$(_IsWebProject)' == 'true'"
        TargetPath="$(TargetPath)"
        PublishDir="$(PublishDir)"
        IsPortable="$(_IsPortable)"
        IsAzure="$(_TransformWebConfigForAzure)" />

    <ItemGroup>
      <_PublishDirFiles
        Include="$(PublishDir)**\*.*">
      </_PublishDirFiles>
    </ItemGroup>

    <CreateItem
      Include="@(_PublishDirFiles)"
      AdditionalMetadata="DestinationRelativePath=%(RecursiveDir)%(Filename)%(Extension)">
      <Output TaskParameter="Include" ItemName="_publishDirFilesWithMetadata"/>
    </CreateItem>

    <ItemGroup>
      <DotNetPublishFiles Include="@(_publishDirFilesWithMetadata)" />
    </ItemGroup>
  </Target>

</Project>
